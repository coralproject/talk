import { Localized } from "@fluent/react/compat";
import cn from "classnames";
import { compact } from "lodash";
import React, { FunctionComponent } from "react";
import { graphql, RelayPaginationProp } from "react-relay";

import { getURLWithCommentID } from "coral-framework/helpers";
import { useToggleState } from "coral-framework/hooks";
import {
  useLoadMore,
  withPaginationContainer,
} from "coral-framework/lib/relay";
import CLASSES from "coral-stream/classes";
import {
  ArrowsDownIcon,
  ArrowsUpIcon,
  ButtonSvgIcon,
  EmailActionReplyIcon,
  LikeIcon,
  ShareExternalLinkIcon,
  SvgIcon,
} from "coral-ui/components/icons";
import { BaseButton, Flex } from "coral-ui/components/v2";

import { HistoryCommentFooterContainer_comment } from "coral-stream/__generated__/HistoryCommentFooterContainer_comment.graphql";
import { HistoryCommentFooterContainer_settings } from "coral-stream/__generated__/HistoryCommentFooterContainer_settings.graphql";
import { HistoryCommentFooterContainerPaginationQuery } from "coral-stream/__generated__/HistoryCommentFooterContainerPaginationQuery.graphql";

import styles from "./HistoryCommentFooterContainer.css";

interface Props {
  comment: HistoryCommentFooterContainer_comment;
  settings: HistoryCommentFooterContainer_settings;
  relay: RelayPaginationProp;
  onGotoConversation: (e: React.MouseEvent) => void;
}

const HistoryCommentFooterContainer: FunctionComponent<Props> = ({
  comment,
  settings,
  relay,
  onGotoConversation,
}) => {
  const [showDetails, , toggleDetailVisibility] = useToggleState();
  const [loadMore] = useLoadMore(relay, 2);

  const hasReactions = comment.actionCounts.reaction.total > 0;
  const hasReplies = comment.replyCount > 0;

  return (
    <>
      <Flex spacing={2}>
        {hasReactions && (
          <BaseButton
            onClick={toggleDetailVisibility}
            className={cn(
              styles.button,
              styles.reactionsButton,
              {
                [styles.activeReactionsButton]: showDetails,
              },
              CLASSES.myComment.reactions
            )}
          >
            <ButtonSvgIcon Icon={LikeIcon} />
            <span className={cn(styles.reactionsButtonText)}>
              {comment.actionCounts.reaction.total} {settings.reaction.label}
            </span>
            <ButtonSvgIcon
              className={styles.buttonCaret}
              Icon={showDetails ? ArrowsUpIcon : ArrowsDownIcon}
              size="xxs"
            />
          </BaseButton>
        )}
        {hasReplies && (
          <div className={cn(styles.replies, CLASSES.myComment.replies)}>
            <SvgIcon
              className={styles.repliesIcon}
              Icon={EmailActionReplyIcon}
            />
            <Localized
              id="profile-historyComment-replies"
              vars={{ replyCount: comment.replyCount }}
            >
              <span>{comment.replyCount} Reply</span>
            </Localized>
          </div>
        )}
        <BaseButton
          anchor
          target="_parent"
          href={getURLWithCommentID(comment.story.url, comment.id)}
          onClick={onGotoConversation}
          className={cn(
            styles.button,
            styles.viewConversation,
            CLASSES.myComment.viewConversationButton
          )}
        >
          <SvgIcon
            Icon={ShareExternalLinkIcon}
            className={styles.viewConversationIcon}
          />
          <Localized id="profile-historyComment-viewConversation">
            <span className={styles.viewConversationText}>
              View Conversation
            </span>
          </Localized>
        </BaseButton>
      </Flex>
      {showDetails && (
        <Flex className={styles.reacterUsernames} alignItems="flex-start">
          <SvgIcon className={styles.reacterUsernamesIcon} Icon={LikeIcon} />
          <Flex spacing={1}>
            <span>
              {compact(
                comment.reactions.edges.map(
                  ({ node: { reacter } }) => reacter?.username
                )
              ).join(", ")}
            </span>
            {relay.hasMore() && (
              <BaseButton
                className={styles.loadMoreReactions}
                onClick={loadMore}
              >
                Load more
              </BaseButton>
            )}
          </Flex>
        </Flex>
      )}
    </>
  );
};

// TODO: (cvle) if this could be autogenerated..
type FragmentVariables = HistoryCommentFooterContainerPaginationQuery;

const enhanced = withPaginationContainer<
  Props,
  HistoryCommentFooterContainerPaginationQuery,
  FragmentVariables
>(
  {
    comment: graphql`
      fragment HistoryCommentFooterContainer_comment on Comment
      @argumentDefinitions(
        count: { type: "Int", defaultValue: 20 }
        cursor: { type: "Cursor" }
      ) {
        id
        reactions(first: $count, after: $cursor)
          @connection(key: "HistoryCommentFooter_reactions") {
          edges {
            node {
              id
              reacter {
                username
              }
            }
          }
        }
        story {
          id
          url
          metadata {
            title
          }
        }
        replyCount
        canReply
        actionCounts {
          reaction {
            total
          }
        }
      }
    `,
    settings: graphql`
      fragment HistoryCommentFooterContainer_settings on Settings {
        reaction {
          label
          icon
        }
      }
    `,
  },
  {
    getConnectionFromProps(props) {
      return props.comment && props.comment.reactions;
    },
    getVariables(props, { count, cursor }, fragmentVariables) {
      return {
        ...fragmentVariables,
        count,
        cursor,
        commentID: props.comment.id,
      };
    },
    query: graphql`
      # Pagination query to be fetched upon calling 'loadMore'.
      # Notice that we re-use our fragment, and the shape of this query matches our fragment spec.
      query HistoryCommentFooterContainerPaginationQuery(
        $count: Int!
        $cursor: Cursor
        $commentID: ID!
      ) {
        comment(id: $commentID) {
          ...HistoryCommentFooterContainer_comment
            @arguments(count: $count, cursor: $cursor)
        }
      }
    `,
  }
)(HistoryCommentFooterContainer);

export default enhanced;
